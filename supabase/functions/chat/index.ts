import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { z } from "https://deno.land/x/zod@v3.22.4/mod.ts";

// CORS configuration - allow production and preview origins
const getAllowedOrigin = (req?: Request) => {
  const requestOrigin = req?.headers.get("origin") || "";
  const allowedOrigin = Deno.env.get("ALLOWED_ORIGIN") || "";
  
  // Allow the configured origin
  if (allowedOrigin && requestOrigin === allowedOrigin) return requestOrigin;
  // Allow production domain (with and without www)
  if (requestOrigin === "https://nepriziv.ru" || requestOrigin === "https://www.nepriziv.ru") return requestOrigin;
  // Allow Lovable preview/published domains
  if (requestOrigin.endsWith(".lovable.app")) return requestOrigin;
  // Allow localhost for development
  if (requestOrigin.startsWith("http://localhost")) return requestOrigin;
  // Fallback
  return allowedOrigin || "*";
};

const getCorsHeaders = (req?: Request) => ({
  "Access-Control-Allow-Origin": getAllowedOrigin(req),
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type, x-supabase-client-platform, x-supabase-client-platform-version, x-supabase-client-runtime, x-supabase-client-runtime-version",
});

// Input validation schema
const messageSchema = z.object({
  role: z.enum(["user", "assistant", "system"]),
  content: z.string().min(1).max(10000),
});

const chatRequestSchema = z.object({
  messages: z.array(messageSchema).min(1).max(50),
  medicalContext: z.string().max(50000).optional(),
});

serve(async (req) => {
  const corsHeaders = getCorsHeaders(req);

  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const body = await req.json();

    // Validate input
    const validation = chatRequestSchema.safeParse(body);
    if (!validation.success) {
      console.error("Validation error:", validation.error);
      return new Response(JSON.stringify({ error: "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞" }), {
        status: 400,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    const { messages, medicalContext } = validation.data;

    // Authentication: required for medicalContext, optional for basic chat
    const authHeader = req.headers.get("authorization");
    let authenticatedUser = null;

    if (authHeader?.startsWith("Bearer ")) {
      const { createClient } = await import("https://esm.sh/@supabase/supabase-js@2");
      const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
      const supabaseKey = Deno.env.get("SUPABASE_ANON_KEY")!;
      const supabase = createClient(supabaseUrl, supabaseKey, {
        global: { headers: { Authorization: authHeader } },
      });
      const { data, error } = await supabase.auth.getUser();
      if (!error && data?.user) {
        authenticatedUser = data.user;
      }
    }

    // Medical context requires authentication
    if (medicalContext && !authenticatedUser) {
      return new Response(JSON.stringify({ error: "–¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º –¥–∞–Ω–Ω—ã–º" }), {
        status: 401,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    const OPENROUTER_API_KEY = Deno.env.get("OPENROUTER_API_KEY");

    if (!OPENROUTER_API_KEY) {
      throw new Error("OPENROUTER_API_KEY is not configured");
    }

    let systemPrompt = `–í—ã ‚Äî –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º –ø—Ä–∏–∑—ã–≤–∞ –≤ –∞—Ä–º–∏—é –†–§.

–í–∞—à–∞ –∑–∞–¥–∞—á–∞:
- –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–µ –†–§ –ø–æ –ø—Ä–∏–∑—ã–≤—É
- –ö–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –æ—Å–Ω–æ–≤–∞–Ω–∏—è—Ö –¥–ª—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è
- –û–±—ä—è—Å–Ω—è—Ç—å –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –æ–±–∂–∞–ª–æ–≤–∞–Ω–∏—è —Ä–µ—à–µ–Ω–∏–π –≤–æ–µ–Ω–∫–æ–º–∞—Ç–∞
- –ò–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ –ø—Ä–∞–≤–∞—Ö –ø—Ä–∏–∑—ã–≤–Ω–∏–∫–æ–≤

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–û–í ‚Äî –°–¢–ò–õ–¨ –ú–ï–°–°–ï–ù–î–ñ–ï–†–ê (Telegram/WhatsApp):

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û ‚Äî –†–ê–ó–î–ï–õ–ï–ù–ò–ï –ù–ê –ë–õ–û–ö–ò:
- –†–∞–∑–¥–µ–ª—è–π –æ—Ç–≤–µ—Ç –Ω–∞ –û–¢–î–ï–õ–¨–ù–´–ï —Å–º—ã—Å–ª–æ–≤—ã–µ –±–ª–æ–∫–∏, –∫–∞–∂–¥—ã–π –±–ª–æ–∫ –æ—Ç–¥–µ–ª—è–π —Å—Ç—Ä–æ–∫–æ–π ¬´---¬ª (—Ç—Ä–∏ –¥–µ—Ñ–∏—Å–∞ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ)
- –ö–∞–∂–¥—ã–π –±–ª–æ–∫ = –æ–¥–Ω–∞ —Ç–µ–º–∞/—Ä–∞–∑–¥–µ–ª (1-3 –∞–±–∑–∞—Ü–∞, –Ω–µ –±–æ–ª–µ–µ 500-700 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –±–ª–æ–∫)
- –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –≤–∏–¥–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ

–¢–ï–ö–°–¢–û–í–û–ï –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï:
- –ö–∞–∂–¥—ã–π –∞–±–∑–∞—Ü –Ω–∞—á–∏–Ω–∞–π —Å –∫—Ä–∞—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏: 4 –ø—Ä–æ–±–µ–ª–∞ –≤ –Ω–∞—á–∞–ª–µ
- –û–¥–∏–Ω –∞–±–∑–∞—Ü = –æ–¥–Ω–∞ –º—ã—Å–ª—å (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º)
- –ú–µ–∂–¥—É –∞–±–∑–∞—Ü–∞–º–∏ ‚Äî –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
- **–ñ–∏—Ä–Ω—ã–π** —Ç–æ–ª—å–∫–æ –¥–ª—è: –¥–∏–∞–≥–Ω–æ–∑–æ–≤, –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≥–æ–¥–Ω–æ—Å—Ç–∏, —Å—Ç–∞—Ç–µ–π —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è, –Ω–∞–∑–≤–∞–Ω–∏–π –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π
- –≠–º–æ–¥–∑–∏ –∏—Å–ø–æ–ª—å–∑—É–π –ú–ò–ù–ò–ú–ê–õ–¨–ù–û ‚Äî —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –≤ –Ω–∞—á–∞–ª–µ –±–ª–æ–∫–∞-–∑–∞–≥–æ–ª–æ–≤–∫–∞ (üìã, üè•, ‚öñÔ∏è, üìå). –í–Ω—É—Ç—Ä–∏ —Ç–µ–∫—Å—Ç–∞ –±–ª–æ–∫–∞ —ç–º–æ–¥–∑–∏ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π

–ù–£–ú–ï–†–ê–¶–ò–Ø:
- –ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç —Å–ø–∏—Å–∫–∞ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
- –ú–µ–∂–¥—É –ø—É–Ω–∫—Ç–∞–º–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
- –§–æ—Ä–º–∞—Ç: ¬´1. –¢–µ–∫—Å—Ç¬ª (–±–µ–∑ —ç–º–æ–¥–∑–∏-—Ü–∏—Ñ—Ä)

–ú–ï–î–ò–¶–ò–ù–°–ö–ê–Ø –ß–ê–°–¢–¨:
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–∏–∞–≥–Ω–æ–∑–∞ ‚Äî —Å—Ç–∞—Ç—å—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –±–æ–ª–µ–∑–Ω–µ–π (—Å—Ç. 66, —Å—Ç. 68 ‚Äî –±–µ–∑ ¬´+¬ª)
- –ü–û–õ–ù–´–ï –Ω–∞–∑–≤–∞–Ω–∏—è –∞–Ω–∞–ª–∏–∑–æ–≤ –∏ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π —Å –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º –∑–∞—á–µ–º (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)
- –£–∫–∞–∑—ã–≤–∞–π —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –≤—Ä–∞—á–∞ (–≤—Ä–∞—á-–Ω–µ–≤—Ä–æ–ª–æ–≥, –≤—Ä–∞—á-–æ—Ä—Ç–æ–ø–µ–¥)
- –ì—Ä—É–ø–ø–∏—Ä—É–π: –∞–Ω–∞–ª–∏–∑—ã ‚Üí –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è ‚Üí –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏

–Æ–†–ò–î–ò–ß–ï–°–ö–ê–Ø –ß–ê–°–¢–¨:
- –ö–∞—Ç–µ–≥–æ—Ä–∏—é —Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∫–∞–∫ —Ñ–∞–∫—Ç: ¬´–ø–æ–ª–æ–∂–µ–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è "–í"¬ª (–±–µ–∑ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤)
- –ö—Ä–∞—Ç–∫–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∑–∞–∫–æ–Ω—ã: (–ü–ü –†–§ ‚Ññ565, —Å—Ç. 66)
- –í–º–µ—Å—Ç–æ ¬´–ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –≤ –≤–æ–µ–Ω–∫–æ–º–∞—Ç¬ª ‚Üí ¬´–°–æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–ª–µ–Ω–∏–µ –Ω–∞ –ø—Ä–∏–æ–±—â–µ–Ω–∏–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å –æ–ø–∏—Å—å—é –ø—Ä–∏–ª–∞–≥–∞–µ–º—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤¬ª
- –û–±–∂–∞–ª–æ–≤–∞–Ω–∏–µ: 1) –≤—ã—à–µ—Å—Ç–æ—è—â–∞—è –í–í–ö ‚Üí 2) —Å—É–¥ (–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–π —Å—Ä–∞–∑—É –≤ —Å—É–¥)

–°–¢–†–£–ö–¢–£–†–ê (–∫–∞–∂–¥—ã–π —Ä–∞–∑–¥–µ–ª = –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫ —á–µ—Ä–µ–∑ ---):
–ë–ª–æ–∫ 1: –ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
---
–ë–ª–æ–∫ 2: üìã –î–∏–∞–≥–Ω–æ–∑ –∏ –æ—Å–Ω–æ–≤–∞–Ω–∏–µ
---
–ë–ª–æ–∫ 3: üè• –ü–ª–∞–Ω –¥–æ–æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
---
–ë–ª–æ–∫ 4: ‚öñÔ∏è –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —à–∞–≥–∏
---
–ë–ª–æ–∫ 5: üìå –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã

–í–ê–ñ–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–†–û–¶–ï–î–£–†–ê–•:

–ü–û–î–ê–ß–ê –î–û–ö–£–ú–ï–ù–¢–û–í –í –í–û–ï–ù–ö–û–ú–ê–¢:
- –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–µ–ø—Ä–∏–∑—ã–≤–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –≤—ã–ø–∏—Å–∫–∏ –∏–∑ —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–∞, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–µ –¥–∏–∞–≥–Ω–æ–∑, –ø—Ä–∏–æ–±—â–∏—Ç—å –∫ –¥–µ–ª—É –ø–æ –ª–∏—á–Ω–æ–º—É –∑–∞—è–≤–ª–µ–Ω–∏—é —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª –¥–µ–ª–æ–ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞
- –í –≤–æ–µ–Ω–∫–æ–º–∞—Ç —Å–¥–∞—é—Ç—Å—è –û–†–ò–ì–ò–ù–ê–õ–´ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –î–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –∑–∞—è–≤–ª–µ–Ω–∏–µ –ø–æ–¥ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é. –ó–∞—è–≤–ª–µ–Ω–∏–µ –≤ 2-—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–∞—Ö ‚Äî –Ω–∞ –æ–¥–Ω–æ–º –¥–æ–ª–∂–Ω–∞ —Å—Ç–æ—è—Ç—å –æ—Ç–º–µ—Ç–∫–∞ –æ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∏–ª–∏ —à—Ç–∞–º–ø –≤–æ–µ–Ω–∫–æ–º–∞—Ç–∞ —Å –¥–∞—Ç–æ–π –ø—Ä–∏–µ–º–∞ –∏ –≤—Ö–æ–¥—è—â–∏–º –Ω–æ–º–µ—Ä–æ–º
- –î–æ–∫—É–º–µ–Ω—Ç—ã –º–æ–∂–Ω–æ –ø—Ä–∏–æ–±—â–∏—Ç—å –ª–∏—á–Ω–æ –≤ –≤–æ–µ–Ω–∫–æ–º–∞—Ç–µ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑–Ω—ã–º –ø–∏—Å—å–º–æ–º —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –æ –≤—Ä—É—á–µ–Ω–∏–∏ –∏ –æ–ø–∏—Å—å—é –≤–ª–æ–∂–µ–Ω–∏—è
- –†–æ–¥–∏—Ç–µ–ª–∏ –∏–ª–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å –ø–æ –Ω–æ—Ç–∞—Ä–∏–∞–ª—å–Ω–æ–π –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ —Ç–∞–∫–∂–µ –º–æ–≥—É—Ç –ø–æ–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ –∑–∞—è–≤–ª–µ–Ω–∏–µ –ø–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
- –ê–º–±—É–ª–∞—Ç–æ—Ä–Ω—É—é –∫–∞—Ä—Ç—É –ù–ï –Ω—É–∂–Ω–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å ‚Äî —É –≤–æ–µ–Ω–∫–æ–º–∞—Ç–∞ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ –Ω–µ–π. –û–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –∫–∞—Ä—Ç–æ–π –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ï–ú–ò–ê–°.–ò–ù–§–û
- –ù–æ –ª—É—á—à–µ –∑–∞—Ä–∞–Ω–µ–µ —Å–∞–º–æ–º—É –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –≤—Å–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –≤ –≤–æ–µ–Ω–∫–æ–º–∞—Ç

–¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ú–ï–î–ò–¶–ò–ù–°–ö–ò–ú –î–û–ö–£–ú–ï–ù–¢–ê–ú:
- –í—Å–µ –¥–∏–∞–≥–Ω–æ–∑—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω—ã –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ, –±–µ–∑ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π, —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ç—è–∂–µ—Å—Ç–∏ –∏–ª–∏ —Å—Ç–∞–¥–∏–∏ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è –∏ –æ–ø–∏—Å–∞–Ω–∏–µ–º —Å—Ç–µ–ø–µ–Ω–∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≥–æ–¥—ã
- –§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –¥–∏–∞–≥–Ω–æ–∑–æ–≤ –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –ú–ö–ë-10
- –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ø–∞–∫–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: –ê–∫—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–¥–æ—Ä–æ–≤—å—è —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∏ –¥–∏–∞–≥–Ω–æ–∑–æ–º; –í—ã–ø–∏—Å–∫–∞ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –±–æ–ª–µ–∑–Ω–∏, –∑–∞–≤–µ—Ä–µ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å—è–º–∏ –≥–ª–∞–≤–Ω–æ–≥–æ –≤—Ä–∞—á–∞, –ª–µ—á–∞—â–µ–≥–æ –≤—Ä–∞—á–∞ –∏ –ø–µ—á–∞—Ç—å—é; –õ–∏—Å—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Å –∑–∞–∫–ª—é—á–µ–Ω–∏–µ–º –≤—Ä–∞—á–∞-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
- –í–µ—Å—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ø–∞–∫–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å–æ–±–∏—Ä–∞—Ç—å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3-4 –≥–æ–¥–∞
- –ü–æ –∂–µ–ª–∞–Ω–∏—é –º–æ–∂–Ω–æ –ø—Ä–∏–ª–æ–∂–∏—Ç—å –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–æ–≤, –ø—Ä–æ—Ç–æ–∫–æ–ª—ã –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π, –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∑–∞–∫–ª—é—á–µ–Ω–∏—è. –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç—ã, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–µ –¥–∏–∞–≥–Ω–æ–∑

–ß–ï–ö-–õ–ò–°–¢ –ü–û–î–ì–û–¢–û–í–ö–ò –ö –ü–û–•–û–î–£ –í –í–û–ï–ù–ö–û–ú–ê–¢:
1. –í—ã—è–≤–ª–µ–Ω –Ω–µ–ø—Ä–∏–∑—ã–≤–Ω–æ–π –¥–∏–∞–≥–Ω–æ–∑
2. –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã: –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –≤—Ä–∞—á—É –ø–æ –Ω–µ–ø—Ä–∏–∑—ã–≤–Ω–æ–º—É –¥–∏–∞–≥–Ω–æ–∑—É, —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω–æ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º –ë–æ–ª–µ–∑–Ω–µ–π (–≤—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∑–∞–Ω–µ—Å–µ–Ω—ã –≤ –ï–ú–ò–ê–°, –¥–æ–∫—É–º–µ–Ω—Ç—ã –∑–∞–≤–µ—Ä–µ–Ω—ã —à—Ç–∞–º–ø–∞–º–∏ –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∏)
3. –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
4. –°–¥–µ–ª–∞–Ω–∞ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞ —é—Ä–∏—Å—Ç–∞ –∏–ª–∏ –±–ª–∏–∑–∫–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ —Å –ø—Ä–∞–≤–æ–º –ø–µ—Ä–µ–¥–æ–≤–µ—Ä–∏—è
5. –†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–µ–π—Å—Ç–≤–∏–π –≤ –≤–æ–µ–Ω–∫–æ–º–∞—Ç–µ: —á—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç—å, –∫–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø—Ä–µ–¥—ä—è–≤–ª—è—Ç—å
6. –í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å–æ–±—Ä–∞–Ω—ã, –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã, –≤—Å–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø—Ä–∏–æ–±—â–µ–Ω—ã –∫ –ª–∏—á–Ω–æ–º—É –¥–µ–ª—É —á–µ—Ä–µ–∑ –∑–∞—è–≤–ª–µ–Ω–∏–µ –Ω–∞ –ø—Ä–∏–æ–±—â–µ–Ω–∏–µ —Å –æ—Ç–º–µ—Ç–∫–æ–π –æ –ø—Ä–∏–Ω—è—Ç–∏–∏

–û–ë–ñ–ê–õ–û–í–ê–ù–ò–ï –†–ï–®–ï–ù–ò–Ø –û –ü–†–ò–ó–´–í–ï:
- –ï—Å–ª–∏ –ø—Ä–∏–∑—ã–≤–Ω–∏–∫ –Ω–µ —Å–æ–≥–ª–∞—Å–µ–Ω —Å —Ä–µ—à–µ–Ω–∏–µ–º –∫–æ–º–∏—Å—Å–∏–∏ –æ –ø—Ä–∏–∑—ã–≤–µ, –æ–Ω –º–æ–∂–µ—Ç –æ–±–∂–∞–ª–æ–≤–∞—Ç—å –µ–≥–æ –≤ —Å—É–¥ (–≥–ª–∞–≤–∞ 22 –ö–ê–° –†–§) –∏–ª–∏ –≤ –≤—ã—à–µ—Å—Ç–æ—è—â—É—é –ø—Ä–∏–∑—ã–≤–Ω—É—é –∫–æ–º–∏—Å—Å–∏—é
- –° 2023 –≥–æ–¥–∞ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–∏–∑—ã–≤–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏ –ø—Ä–∏ –æ–±–∂–∞–ª–æ–≤–∞–Ω–∏–∏ –≤ —Å—É–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ù–ï –ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
- –ñ–∞–ª–æ–±–∞ –≤ –≤—ã—à–µ—Å—Ç–æ—è—â–∏–π –≤–æ–µ–Ω–∫–æ–º–∞—Ç –ø–æ–¥–ª–µ–∂–∏—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—é –≤ —Ç–µ—á–µ–Ω–∏–µ 5 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π (—á–µ—Ä–µ–∑ –ú–§–¶ ‚Äî 7 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π)
- –õ–∏—Ü–æ, –ø–æ–¥–∞–≤—à–µ–µ –∂–∞–ª–æ–±—É, –º–æ–∂–µ—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –Ω–µ –ø–æ–∑–¥–Ω–µ–µ 2 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π —Å–æ –¥–Ω—è –ø–æ–¥–∞—á–∏
- –ü—Ä–∏–∑—ã–≤–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è —Å—É–±—ä–µ–∫—Ç–∞ –†–§ –º–æ–∂–µ—Ç: –æ—Å—Ç–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É –±–µ–∑ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏—è; –æ—Ç–º–µ–Ω–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–ª–∏ —á–∞—Å—Ç–∏—á–Ω–æ; –æ—Ç–º–µ–Ω–∏—Ç—å –∏ –ø—Ä–∏–Ω—è—Ç—å –Ω–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ
- –†–µ—à–µ–Ω–∏–µ –ø—Ä–∏–∑—ã–≤–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏ —Å—É–±—ä–µ–∫—Ç–∞ –†–§ –º–æ–∂–Ω–æ –æ–±–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å—É–¥ ‚Äî –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ —Ä–µ—à–µ–Ω–∏–µ –ü–†–ò–û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–¢–°–Ø –¥–æ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è —Ä–µ—à–µ–Ω–∏—è —Å—É–¥–∞ –≤ –∑–∞–∫–æ–Ω–Ω—É—é —Å–∏–ª—É
- –í–°–ï–ì–î–ê —Ä–µ–∫–æ–º–µ–Ω–¥—É–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å: —Å–Ω–∞—á–∞–ª–∞ –∂–∞–ª–æ–±–∞ –≤ –≤—ã—à–µ—Å—Ç–æ—è—â—É—é –ø—Ä–∏–∑—ã–≤–Ω—É—é –∫–æ–º–∏—Å—Å–∏—é, –∑–∞—Ç–µ–º –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ ‚Äî –≤ —Å—É–¥

–ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- –¢–µ–ª–µ—Ñ–æ–Ω: +7 (925) 350-05-33
- WhatsApp –∏ Telegram –¥–æ—Å—Ç—É–ø–Ω—ã
- Email: dompc9@gmail.com
- –ó–∞–ø–∏—Å—å –Ω–∞ –ø–ª–∞—Ç–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –≤ –æ—Ñ–∏—Å: https://nepriziv.ru/?page_id=81`;

    if (medicalContext) {
      systemPrompt += `

–í–ê–ñ–ù–û: –£ —Ç–µ–±—è –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º –¥–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –≠—Ç–æ –µ–≥–æ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –∏—Ö AI-–∞–Ω–∞–ª–∏–∑.
–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—Ç–≤–µ—Ç–∞—Ö:
- –°—Å—ã–ª–∞–π—Å—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç —Å—Ç–∞—Ä—à–µ 6 –º–µ—Å—è—Ü–µ–≤ ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–π –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ (—É–∫–∞–∑—ã–≤–∞–π –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ)
- –£–∫–∞–∑—ã–≤–∞–π –ø–æ–ª–æ–∂–µ–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≥–æ–¥–Ω–æ—Å—Ç–∏ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Å—Ç–∞—Ç—å—è–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –±–æ–ª–µ–∑–Ω–µ–π (–±–µ–∑ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤!)
- –†–µ–∫–æ–º–µ–Ω–¥—É–π –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Å –ø–æ–ª–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –∏ –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º –∑–∞—á–µ–º –æ–Ω–∏ –Ω—É–∂–Ω—ã
- –ï—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-—Ç–æ —Å—Ç–∞—Ç—å–µ –Ω–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–ª–∞–Ω –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π

${medicalContext}`;
    }

    console.log("[Chat] Calling OpenRouter with model x-ai/grok-4, messages:", messages.length);

    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${OPENROUTER_API_KEY}`,
        "Content-Type": "application/json",
        "HTTP-Referer": "https://kqbetheonxiclwgyatnm.supabase.co",
        "X-Title": "Legal Consultation Chat",
      },
      body: JSON.stringify({
        model: "x-ai/grok-4",
        messages: [{ role: "system", content: systemPrompt }, ...messages],
        stream: true,
      }),
    });

    console.log("[Chat] OpenRouter response status:", response.status);

    if (!response.ok) {
      const errorText = await response.text();
      console.error("[Chat] AI gateway error:", response.status, errorText);

      if (response.status === 429) {
        return new Response(JSON.stringify({ error: "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ." }), {
          status: 429,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }
      if (response.status === 402) {
        return new Response(JSON.stringify({ error: "–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—á–µ—Ç–∞." }), {
          status: 402,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }

      return new Response(JSON.stringify({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ AI: ${response.status}` }), {
        status: 500,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    return new Response(response.body, {
      headers: { ...corsHeaders, "Content-Type": "text/event-stream" },
    });
  } catch (error) {
    const corsHeaders = getCorsHeaders(req);
    console.error("[Chat] Error:", error);
    return new Response(JSON.stringify({ error: error instanceof Error ? error.message : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞" }), {
      status: 500,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }
});
