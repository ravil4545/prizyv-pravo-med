-- Drop the old medical_tests table
DROP TABLE IF EXISTS public.medical_tests CASCADE;

-- Create test_templates table with predefined tests
CREATE TABLE public.test_templates (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  test_name TEXT NOT NULL UNIQUE,
  category TEXT,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- Create user_test_results table
CREATE TABLE public.user_test_results (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL,
  template_id UUID REFERENCES public.test_templates(id) ON DELETE CASCADE,
  test_date DATE,
  file_path TEXT,
  ai_summary TEXT,
  user_notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- Enable Row Level Security
ALTER TABLE public.test_templates ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_test_results ENABLE ROW LEVEL SECURITY;

-- Policies for test_templates (everyone can read)
CREATE POLICY "Everyone can view test templates"
ON public.test_templates
FOR SELECT
USING (true);

-- Policies for user_test_results
CREATE POLICY "Users can view their own test results"
ON public.user_test_results
FOR SELECT
USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own test results"
ON public.user_test_results
FOR INSERT
WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own test results"
ON public.user_test_results
FOR UPDATE
USING (auth.uid() = user_id);

CREATE POLICY "Users can delete their own test results"
ON public.user_test_results
FOR DELETE
USING (auth.uid() = user_id);

-- Create trigger for automatic timestamp updates
CREATE TRIGGER update_user_test_results_updated_at
BEFORE UPDATE ON public.user_test_results
FOR EACH ROW
EXECUTE FUNCTION public.update_updated_at_column();

-- Create indexes
CREATE INDEX idx_user_test_results_user_id ON public.user_test_results(user_id);
CREATE INDEX idx_user_test_results_template_id ON public.user_test_results(template_id);
CREATE INDEX idx_user_test_results_test_date ON public.user_test_results(test_date);

-- Insert all test templates from the uploaded file
INSERT INTO public.test_templates (test_name, category) VALUES
('Клинический анализ крови: общий анализ, лейкоформула, СОЭ (с микроскопией мазка крови при наличии патологических сдвигов)', 'Анализы крови'),
('Клинический анализ мочи', 'Анализы мочи'),
('Общий белок мочи (разовая/суточная)', 'Анализы мочи'),
('Тромбоциты, микроскопия (подсчет в окрашенном мазке по методу Фонио)', 'Анализы крови'),
('Скорость клубочковой фильтрации (по Кокрофту-Голту)', 'Анализы крови'),
('Биохимия крови, расширенный профиль', 'Анализы крови'),
('Посев мочи', 'Анализы мочи'),
('Анализ полиморфизмов в генах F2 и F5 (факторы свертывающей системы, 2 точки)', 'Генетические исследования'),
('Расширенное исследование генов системы гемостаза (развитие тромбофилии): F2, F5, MTHFR, MTR, MTRR, F13, FGв, ITGA2, ITGв3, F7, PAI-1', 'Генетические исследования'),
('Коагулограмма развернутая', 'Анализы крови'),
('ТТГ тиреотропный гормон', 'Гормональные исследования'),
('Т4 свободный', 'Гормональные исследования'),
('Т3 свободный', 'Гормональные исследования'),
('Антитела к тиреопероксидазе (АТ-ТПО)', 'Иммунологические исследования'),
('Антитела тиреоглобулину (АТ-ТГ)', 'Иммунологические исследования'),
('Комплексное серологическое исследование: сифилис, ВИЧ, гепатит В (HвsAg), гепатит С (a-HCV)', 'Инфекционные маркеры'),
('Общий иммуноглобулин IgE', 'Иммунологические исследования'),
('Анализ крови "Фадиатоп"', 'Аллергологические исследования'),
('Гликированный гемоглобин (HbA1c)', 'Анализы крови'),
('Пероральный глюкозотолерантный тест (ПТТГ)', 'Анализы крови'),
('Агрегация тромбоцитов', 'Анализы крови'),
('Активность фактора фон Виллебранда', 'Анализы крови'),
('Активность фактора VIII', 'Анализы крови'),
('Мутация фактора V (Лейденская мутация)', 'Генетические исследования'),
('Мутация гена протромбина G20210A', 'Генетические исследования'),
('Антистрептолизин-О (АСЛ-О)', 'Иммунологические исследования'),
('С-реактивный белок (СРБ)', 'Анализы крови'),
('Ревматоидный фактор (РФ)', 'Иммунологические исследования'),
('Анализ мочи на микроальбуминурию', 'Анализы мочи'),
('Антитела к циклическому цитруллинированному пептиду', 'Иммунологические исследования'),
('Антиген HLA-B27', 'Иммунологические исследования'),
('Антинуклеарный фактор (АНФ) на HEp-2 клетках', 'Иммунологические исследования'),
('Антинуклеарные антитела (АНА, иммуноблот)', 'Иммунологические исследования'),
('Антинейтрофильные цитоплазматические антитела (АНЦА, ANCA)', 'Иммунологические исследования'),
('Консультация врача-дерматолога', 'Консультации врачей'),
('Биопсия кожи при дерматозах', 'Биопсия'),
('Гистологическое исследование биоптата кожи', 'Гистология'),
('Рентген длинных трубчатых костей', 'Рентгенография'),
('Ретген стоп в боковой проекции с нагрузкой', 'Рентгенография'),
('Рентген шейного отдела позвоночника в прямой проекции', 'Рентгенография'),
('Рентген грудного отдела позвоночника в прямой проекции', 'Рентгенография'),
('Рентген поясничного отдела позвоночника в прямой проекции', 'Рентгенография'),
('Рентген шейного отдела позвоночника в боковой проекции', 'Рентгенография'),
('Рентген грудного отдела позвоночника в боковой проекции', 'Рентгенография'),
('Рентген поясничного отдела позвоночника в боковой проекции', 'Рентгенография'),
('Рентген крупных суставов в двух проекциях', 'Рентгенография'),
('Рентгенография нижних конечностей с измерением длины', 'Рентгенография'),
('Внутривенная (экскреторная) урография', 'Рентгенография'),
('Радиоизотопные исследования (динамическая нефросцинтиграфия)', 'Радиология'),
('Эхокардиография', 'УЗИ'),
('Эхокардиография с физической нагрузкой (Стресс ЭХО)', 'УЗИ'),
('Ультразвуковое исследование щитовидной железы и паращитовидных желез', 'УЗИ'),
('Ультразвуковое исследование почек и надпочечников', 'УЗИ'),
('Ультразвуковое исследование органов мошонки', 'УЗИ'),
('Ультразвуковое исследование органов брюшной полости (комплексное)', 'УЗИ'),
('УЗИ щитовидной железы, экспертное', 'УЗИ'),
('Дуплексное сканирование сонных и позвоночных артерий', 'УЗИ'),
('Дуплексное сканирование артерий нижних конечностей', 'УЗИ'),
('Дуплексное сканирование артерий верхних конечностей', 'УЗИ'),
('Дуплексное сканирование вен нижних конечностей', 'УЗИ'),
('Дуплексное сканирование вен верхних конечностей', 'УЗИ'),
('Рентгенография органов грудной клетки в двух проекциях', 'Рентгенография'),
('Компьютерная томография органов грудной клетки', 'КТ'),
('Компьютерная томография органов брюшной полости и забрюшинного пространства', 'КТ'),
('Магнитно-резонансная томография головного мозга', 'МРТ'),
('Магнитно-резонансная томография шейного отдела позвоночника', 'МРТ'),
('Магнитно-резонансная томография грудного отдела позвоночника', 'МРТ'),
('Магнитно-резонансная томография поясничного отдела позвоночника', 'МРТ'),
('Электрокардиография (ЭКГ)', 'Функциональная диагностика'),
('Суточное мониторирование ЭКГ (холтеровское мониторирование)', 'Функциональная диагностика'),
('Суточное мониторирование артериального давления (СМАД)', 'Функциональная диагностика'),
('Спирометрия', 'Функциональная диагностика'),
('Электроэнцефалография (ЭЭГ)', 'Функциональная диагностика'),
('Реоэнцефалография (РЭГ)', 'Функциональная диагностика'),
('Электронейромиография (ЭНМГ)', 'Функциональная диагностика'),
('Консультация врача-невролога', 'Консультации врачей'),
('Консультация врача-кардиолога', 'Консультации врачей'),
('Консультация врача-эндокринолога', 'Консультации врачей'),
('Консультация врача-хирурга', 'Консультации врачей'),
('Консультация врача-уролога', 'Консультации врачей'),
('Консультация врача-офтальмолога', 'Консультации врачей'),
('Консультация врача-оториноларинголога (ЛОР)', 'Консультации врачей'),
('Консультация врача-психиатра', 'Консультации врачей'),
('Консультация врача-стоматолога', 'Консультации врачей'),
('Осмотр глазного дна (офтальмоскопия)', 'Офтальмология'),
('Определение остроты зрения', 'Офтальмология'),
('Периметрия (исследование полей зрения)', 'Офтальмология'),
('Тонометрия (измерение внутриглазного давления)', 'Офтальмология'),
('Аудиометрия', 'Оториноларингология'),
('Импедансометрия', 'Оториноларингология'),
('Рентгенография придаточных пазух носа', 'Рентгенография'),
('Флюорография органов грудной клетки', 'Рентгенография'),
('ФГДС (фиброгастродуоденоскопия)', 'Эндоскопия'),
('Колоноскопия', 'Эндоскопия'),
('Ректороманоскопия', 'Эндоскопия'),
('Бронхоскопия', 'Эндоскопия'),
('Цистоскопия', 'Эндоскопия'),
('Анализ кала на скрытую кровь', 'Анализы кала'),
('Копрограмма', 'Анализы кала'),
('Анализ кала на яйца глистов', 'Анализы кала');

-- Create storage bucket for test result files
INSERT INTO storage.buckets (id, name, public)
VALUES ('test-results', 'test-results', false);

-- Storage policies for test result files
CREATE POLICY "Users can view their own test result files"
ON storage.objects
FOR SELECT
USING (
  bucket_id = 'test-results' AND
  auth.uid()::text = (storage.foldername(name))[1]
);

CREATE POLICY "Users can upload their own test result files"
ON storage.objects
FOR INSERT
WITH CHECK (
  bucket_id = 'test-results' AND
  auth.uid()::text = (storage.foldername(name))[1]
);

CREATE POLICY "Users can update their own test result files"
ON storage.objects
FOR UPDATE
USING (
  bucket_id = 'test-results' AND
  auth.uid()::text = (storage.foldername(name))[1]
);

CREATE POLICY "Users can delete their own test result files"
ON storage.objects
FOR DELETE
USING (
  bucket_id = 'test-results' AND
  auth.uid()::text = (storage.foldername(name))[1]
);