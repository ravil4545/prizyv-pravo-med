

## Подключение медицинских данных пользователя к AI чату

### Что будет сделано

AI чат в личном кабинете (`/dashboard/ai-chat`) получит доступ к загруженным медицинским документам, их AI-анализу и истории болезни. ИИ будет вести беседу, зная текущее положение дел пользователя по медицинской части.

### Как это будет работать

1. При открытии чата (и при отправке первого сообщения) фронтенд загружает из базы данных:
   - Список медицинских документов пользователя (`medical_documents_v2`) с типами и датами
   - Привязки документов к статьям Расписания болезней (`document_article_links`) с AI-анализом (шансы категории В, рекомендации, объяснения)
   - Названия статей из `disease_articles_565`

2. Эти данные формируются в текстовый контекст и передаются в edge function `chat` вместе с сообщениями.

3. Edge function добавляет этот контекст в системный промпт, чтобы ИИ мог:
   - Отвечать с учетом конкретных диагнозов пользователя
   - Давать рекомендации по недостающим обследованиям
   - Указывать на давность документов
   - Оценивать шансы на категорию В по конкретным статьям

### Технические детали

**Файл: `src/pages/AIChatDashboardPage.tsx`**
- Добавить функцию `loadMedicalContext()`, которая загружает данные из `medical_documents_v2`, `document_article_links`, `disease_articles_565`
- Формировать текстовое резюме медицинского состояния пользователя
- Передавать `medicalContext` в тело запроса к edge function при вызове `sendMessage()`

**Файл: `supabase/functions/chat/index.ts`**
- Добавить в схему валидации опциональное поле `medicalContext` (строка до 50000 символов)
- Расширить системный промпт: если `medicalContext` передан, добавить блок с данными о медицинском состоянии пользователя
- Инструктировать ИИ учитывать эти данные при ответах, обращать внимание на давность документов, давать конкретные рекомендации

**Формат медицинского контекста** (пример):
```text
=== МЕДИЦИНСКИЕ ДОКУМЕНТЫ ПОЛЬЗОВАТЕЛЯ ===

Документ: Выписка из поликлиники
Тип: Амбулаторная карта
Дата: 15.03.2025 (давность: 11 мес.)
Статья 68 (Плоскостопие) — шанс кат. В: 10%
  Рекомендации: Рентген стоп под нагрузкой
Статья 66 (Болезни позвоночника) — шанс кат. В: 75%
  Рекомендации: МРТ пояснично-крестцового отдела

Всего документов: 3
Статьи с наибольшим шансом: Ст.66 (75%), Ст.43 (60%)
```

### Безопасность
- Медицинские данные загружаются с учетом RLS (пользователь видит только свои документы)
- Контекст передается в теле POST-запроса, не сохраняется в логах
- Edge function не хранит медицинские данные, использует только для формирования ответа

